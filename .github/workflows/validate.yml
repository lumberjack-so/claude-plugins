name: Validate Marketplace

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Validate marketplace.json structure
        run: |
          if [ ! -f ".claude-plugin/marketplace.json" ]; then
            echo "Error: marketplace.json not found"
            exit 1
          fi

          # Check if JSON is valid
          if ! jq empty .claude-plugin/marketplace.json 2>/dev/null; then
            echo "Error: Invalid JSON in marketplace.json"
            exit 1
          fi

          echo "✓ marketplace.json is valid"

      - name: Validate required fields
        run: |
          # Check for required fields in marketplace.json
          required_fields=("name" "version" "description" "owner" "plugins")

          for field in "${required_fields[@]}"; do
            if ! jq -e ".$field" .claude-plugin/marketplace.json > /dev/null; then
              echo "Error: Missing required field: $field"
              exit 1
            fi
          done

          echo "✓ All required fields present"

      - name: Validate plugin references
        run: |
          # Check that all referenced plugin directories exist
          plugins=$(jq -r '.plugins[].source' .claude-plugin/marketplace.json)
          plugin_root=$(jq -r '.pluginRoot // "./plugins"' .claude-plugin/marketplace.json)

          for plugin in $plugins; do
            full_path="$plugin_root/$plugin"
            if [ ! -d "$full_path" ]; then
              echo "Error: Plugin directory not found: $full_path"
              exit 1
            fi
            echo "✓ Found plugin: $full_path"
          done

      - name: Validate LICENSE exists
        run: |
          if [ ! -f "LICENSE" ]; then
            echo "Error: LICENSE file not found"
            exit 1
          fi
          echo "✓ LICENSE file present"

      - name: Validate README exists
        run: |
          if [ ! -f "README.md" ]; then
            echo "Error: README.md not found"
            exit 1
          fi
          echo "✓ README.md present"
